---
- hosts: all

  vars:
    LETSENCRYPT: "{{ lookup('env','TC_LETSENCRYPT') }}"

  tasks:

  # Traccar container
  - name: Create /opt/traccar
    become: true
    file:
      path: "/opt/traccar"
      state: directory
      mode: 0755
      owner: root
      group: root

  - name: Copy mytraccar.xml
    become: true
    copy:
      src: "mytraccar.xml"
      dest:  "/opt/traccar/mytraccar.xml"
      mode: 0644
      owner: root
      group: root
      force: yes

  - name: Launch database container
    become: yes
    docker_container:
      name: db
      image: mysql:5.7.18
      ports:
       - 3306:3306
      networks:
       - name: traccar
      env:
        MYSQL_ROOT_PASSWORD: L3g0l4s2020=*
        MYSQL_DATABASE: traccardb
        MYSQL_USER: traccarUsr
        MYSQL_PASSWORD : abc123@#$.

  - name: Start traccar container (port 8082)
    become: yes
    docker_container:
      name: traccar
      image: traccar/traccar:4.6
      state: started
      recreate: yes
      restart_policy: always
      networks:
        - name: traccar
      networks_cli_compatible: yes
      ports:
        - 8082:8082
        - 5000-5150:5000-5150
        - 5000-5150:5000-5150/udp
      volumes:
        - /opt/traccar/mytraccar.xml:/opt/traccar/conf/traccar.xml
      depends_on:
        - db
    when: LETSENCRYPT == 'true'

  - name: Start traccar container (port 80)
    become: yes
    docker_container:
      name: traccar
      image: traccar/traccar:4.6
      state: started
      recreate: yes
      restart_policy: always
      networks:
        - name: traccar
      networks_cli_compatible: yes
      ports:
        - 80:8082
        - 5000-5150:5000-5150
        - 5000-5150:5000-5150/udp
      volumes:
        - /opt/traccar/mytraccar.xml:/opt/traccar/conf/traccar.xml
      depends_on:
        - db
    when: LETSENCRYPT == 'false'
